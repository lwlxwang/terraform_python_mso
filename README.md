# Introduction

Configuring Cisco MSO using Terraform can be a time- and labor intensive task due to the many Terraform objects available in the Terraform MSO provider. To see this list of objects, please visit the [documentation](https://registry.terraform.io/providers/CiscoDevNet/mso/latest/docs).

To facilitate with this, this python script will parse a variable file in YAML format and will create the corresponding Terraform files to configure Cisco MSO. 

The idea behind the tool is that you can define the objects in a YAML file while also defining the relations between these objects. Manipulating a YAML file is much easier than editing Terraform files manually (which requires a lot of copy/paste work). As a benefit, the variables file will in fact almost be a blueprint for the logical architecture you want to create on Cisco MSO.

# How it works

Create a file called `variables.yml` file with the following content. In this example, we will create two tenants onto Cisco MSO. You will see the provider to be used, the sites available in MSO and the tenants to be created. Note that the name of the variable file can be anything, you can specify the filename using the CLI when executing the script.
```
---
providers:
  username: admin
  password: ---
  url: https://w.x.y.z
sites: 
  - site1: SaS_APIC
  - site2: Site2
tenants: 
  - tenant: tenant1
    name: Tenant_Demo1
    description: Tenant_Demo1 description
    sites: 
      - site1
      - site2
  - tenant: tenant2
    name: Tenant_Demo2
    description: Tenant_Demo2 description
    sites: 
      - site1
```
Execute the Python script (see section `Run the Python script` below) and you will find following files in the `terraform_files` directory:

a) the main tf file

```
terraform {
  required_providers {
    mso = {
      source  = "ciscodevnet/mso"
      version = "0.1.2"
    }
  }
}

provider "mso" {
  username    = "admin"
  password    = "---"
  url         = "https://w.x.y.z"
  insecure    = true
}

data "mso_site" "site1" {
  name  = "SaS_APIC"
}

data "mso_site" "site2" {
  name  = "Site2"
}

resource "mso_tenant" "tenant1" {
  name              =  "Tenant_Demo1"
  display_name      =  "Tenant_Demo1"
  description       =  "Tenant_Demo1 description"
  site_associations {
    site_id = data.mso_site.site1.id
  }
  site_associations {
    site_id = data.mso_site.site2.id
  }
}

resource "mso_tenant" "tenant2" {
  name              =  "Tenant_Demo2"
  display_name      =  "Tenant_Demo2"
  description       =  "Tenant_Demo2 description"
  site_associations {
    site_id = data.mso_site.site1.id
  }
}
```
b) the corresponding outputs:
```
output tenant_tenant1 {
    value = mso_tenant.tenant1.name
}

output tenant_tenant2 {
    value = mso_tenant.tenant2.name
}
```


# Pre-Requisites

## Install requirements
Install the dependencies listed in the requirements.txt file or just run the following:

```
pip3 install -r requirements.txt
```

## Install Terraform

Download and install [Terraform](https://www.terraform.io/downloads.html) for your specific platform

## Clone the repository

Clone the repository onto your system:

```
git clone https://github.com/wiwa1978/terraform_python_mso.git
```

# Run the Python script

We will use the example from the `How it works` section above. We have created a `variables.yml` file to start with. Next, run the main.py script using one of the following methods:

1) One Terraform file (--no-split option)
```
python3 main.py --no-split --variable-file variables.yml  
```
The generated Terraform files will be located in the `terraform_files` directory as one single Terraform file (e.g main.tf) with a corresponding output file (e.g. output.tf)

1) Seperate Terraform files (--split option)
```
python3 main.py --split --variable-file variables.yml  
```
The generated Terraform files will be located in the `terraform_files` directory. It will generate multiple terraform files per MSO resource. It also includes the corresponding output file (e.g. output.tf)

Note:
- in the variables_python.yml file one should specify the correct MSO host and username/password

# Run the Terraform files

Once the files have been generated by the Python script, copy the files from the `terraform_files` directory to your project. Then run the following commands to execute:

- terraform init
- terraform plan -parallelism=1
- terraform apply -parallelism=1